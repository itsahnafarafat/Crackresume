
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin status
    function isAdmin(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.isAdmin == true;
    }

    // Users can only read their own data.
    // User documents are created via a server-side function during signup.
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
    }

    // Users can manage their own job documents.
    match /jobs/{jobId} {
       allow read, list, create, update, delete: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Posts can be read by anyone, but only managed via the secure Genkit flow (which runs with admin privileges)
    match /posts/{postId} {
      allow read;
      // Disallow all direct writes from the client. All mutations must go through the managePost flow.
      allow write: if false; 
    }
  }
}
